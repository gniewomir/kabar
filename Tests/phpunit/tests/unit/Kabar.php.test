<?php
/**
 * Tests assume that parent class for \kabar\Kabar (parent \Dice\Dice) is tested
 */
class KabarTests extends WP_UnitTestCase {

    public function setUp() {
        $this->kabar = new \kabar\Kabar();
    }

    /**
     * @dataProvider classNameProvider
     */
    public function testParseName_ShouldNormalizeClassName($class, $expected, $rule) {
        $class = $this->kabar->parseName($class);
        $this->assertEquals(
            $expected,
            $class
        );
    }

    /**
     * @dataProvider classNameProvider
     */
    public function testCreate_ShouldInstantiateClass($class, $expected, $rule) {
        if (!empty($rule)) {
            $this->kabar->addRule($class, $rule);
        }
        $this->assertInstanceOf(
            $expected,
            $this->kabar->create($class)
        );
    }

    /**
     * @dataProvider sharedObjectsClassNameProvider
     */
    public function testCreate_ShouldReturnSharedInstance($class)
    {
        $this->kabar->addRule($class, array('shared'=>true));
        $expected = $this->kabar->create($class);
        $expected->prop = 'test';
        $tested   = $this->kabar->create($class);
        $this->assertTrue(
            ($expected === $tested)
        );
    }

    /**
     * @dataProvider sharedObjectsClassNameProvider
     */
    public function testMaybeShare_ShouldAddSharedRuleToClassesInSpecifedNamespaces($class)
    {
        $this->assertTrue($this->kabar->maybeShare($class));
    }

    /**
     * @dataProvider classNameProvider
     */
    public function testMaybeShare_ShouldNotAddSharedRuleToClassesInSpecifedNamespaces($class)
    {
        $this->assertFalse($this->kabar->maybeShare($class));
    }

    public function classNameProvider()
    {
        return array(
            // full names
            array('kabar\\Utility\\Template\\Template',   'kabar\\Utility\\Template\\Template', array()),
            array('kabar/Utility/Template/Template',      'kabar\\Utility\\Template\\Template', array()),
            array('\\kabar\\Utility\\Template\\Template', 'kabar\\Utility\\Template\\Template', array()),
            array('/kabar/Utility/Template/Template',     'kabar\\Utility\\Template\\Template', array()),
            array('kabar\\Module\\Sidebars\\Cleaner',     'kabar\\Module\\Sidebars\\Cleaner',   array()),
            // shortcuts
            array('kabar/Utility/Template',               'kabar\\Utility\\Template\\Template', array()),
            array('/kabar/Utility/Template',              'kabar\\Utility\\Template\\Template', array()),
            array('/kabar/Utility/Template/',             'kabar\\Utility\\Template\\Template', array()),
            array('kabar/Utility/Template/',              'kabar\\Utility\\Template\\Template', array())
        );
    }

    public function sharedObjectsClassNameProvider()
    {
        return array(
            array('kabar\\Module\\Scripts\\Scripts'),
            array('kabar\\Module\\Sidebars\\Sidebars'),
            array('kabar\\Factory\\Template\\Template'),
            array('kabar\\Module\\Pages\\Pages'),
            array('kabar\\Module\\Pages\\Pages'),
            array('kabar\\Module\\Pages\\Pages')
        );
    }
}
